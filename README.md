# CE-QUAL-W2 practical example for Shasta Reservoir
This repository houses the executables and data required to run the CE-QUAL-W2 hydrodynamics model (version 4.5) for a Shasta Reservoir test case. This README file provides a high-level overview of the contents of the repository, setting up the CE-QUAL-W2 model, 
running the model, and analyzing the output via raw output data and the W2 post-processor tool. This repository supports the conceptual discussion of the CE-QUAL-W2 model on the Waterprogramming Blog Post [here](https://waterprogramming.wpcomstaging.com/2025/10/16/ce-qual-w2-overview-and-application/). CE-QUAL-W2 will be referred to as 'W2' below for brevity.

## Brief input data description
W2 requires at least one inflow and outflow file, at least one inflow temperature file, a meteorology file including at a minimum: (air temperature, dewpoint temperature, wind speed, wind direction, and cloud cover), and a bathymetry file. These files are pre-staged in this repository in the aptly named inflow, outflow, met, and bathymetry folders. All of these data are specified with Julian Day time delineation for compatibility with the W2 model. Inflow, outflow, and inflow temperature data come from gage data downloaded from the CA Data Exchange Center (CDEC). All the meteorological variables were derived from ERA5 reanalysis and averaged over the Shasta lake geographical area. The bathymetry file was adapted from a previous study (Hallnan et al., 2020) and provided courtesy of Dr. Laurel Saito at The Nature Conservancy.
## Running the model
With all pre-staged data in place, running the model is relatively straightforward. The 'w2_con_SHA_90-24.xlsm' macro-enabled worksheet is the main driver 'script' for the W2 model. For the model to run, this worksheet must be setup to properly read-in the inputs and configure the model. There are a million and one gotchas in this process. The version here should run once the repository has been downloaded to your machine. Running the model is accomplished in 3 steps:
1) Open the 'w2_con_SHA_90-24.xlsm' worksheet. When everything has been setup correctly (for the purposes of this example, everything is as it should be), click the big gray button near the top that say 'Export to CSV file'. This exports the model configuration to the 'w2_con.csv' file that the W2 model is expecting to begin its simulation.
2) Before you run the actual W2 model, there is a convenient pre-processor 'preW2-v45_64.exe' that checks the configuration file for any errors. Double click on this file. It will run through a bunch of numbers and stuff. At the end, if it displays 'Normal Termination Criteria' and 0 Errors, you are good to go. It will show a bunch of warnings. These are related to the daily timestep of the input data being suboptimal (W2 produce higher fidelity results at sub-daily timesteps). Warnings will not prevent the model from running. You can view any Errors or Warnings in the pre.wrn and pre.err output files that show up in the base repository after the preprocessor is run.
3) Game time. Run the model by double-clicking the 'w2_v45_64.exe' file. A box will come up showing a bunch of model parameters and values as the model runs. Watch it if you want. This model should run to completion in roughly 10 minutes. At run completion, close out the model.
## Model output
The W2 model outputs a number of files. I will just mention two outputs that are useful. The first is the timeseries output .csv files. These outputs are specified in lines 355-363 of the 'w2_con_SHA_90-24.xlsm' in terms of which segments and layers to output. As currently configured, these outputs are set for the segment closest to the dam (segment 21) at differing depths corresponding to the 4 output structures at Shasta Dam. The timeseries .csv files are output to the 'tsr_output' folder. There are a number of useful values in these output files and these are discussed in more detail in the 'Detailed Notes' section below.  

The second key output is the W2 postprocessor file with a .w2l suffix. This filename is specified in line 870 of the 'w2_con_SHA_90-24.xlsm' control file and is labeled 'Shasta.w2l' in this version.
## W2 post-processor
In the 'docs' folder of this repository, there is a step-by-step guide, 'W2 post-processor tool example.pdf', to run the W2 post-processor tool 'W2_Post3.exe' after the W2 model has been run. This provides a very gentle guide to viewing some of the more interesting outputs of the W2 model with this tool
## Detailed notes
### Input files
_Overall:_ The discussion of the input files below is intended to highlight key elements of the input files for interpretation. For practical concerns of running the W2 model, it is important to note that the model is very sensitive to input file formatting and will not run if anything is amiss. W2 model troubleshooting can be challenging, so trying to retain aspects of the original file structure when making modifications to inputs is a good strategy.  
   
_Bathymetry:_ As noted above, the bathymetry file for this Shasta example was provided from a previous study. Creating a bathymetry file for a real-world reservoir is one of the biggest challenges in setting up a CE-QUAL-W2 model. There are some Pythonic methods that integrate with QGIS to do this: [QGIS plug-in](https://plugins.qgis.org/plugins/create_bathymetry/#plugin-details); [QGIS plug-in Wiki](https://github.com/WQDSS/qgis-cequalw2-bath/wiki). I have not used these tools and cannot speak to their ease of use. If you look at the bathymetry file itself, you can see the basic Branch/Segment/Layer structure described in the Blog post. Segment #s are indicated in the 2nd row of the file and segments with all 0s in the columns delineate splits between Branches. The longitudinal length of each segment is described in row 3 (DLX), the starting water surface elevation in row 4 (ELWS), the orientation of each element in radians in row 5 (PHI0), and a friction parameter in row 6 (FRIC). The 1st column specifies the heights for each layer (LAYERH) in meters and you can note that the upper layers have smaller layer heights as compared to the lower layers. This is to capture more resolution in the upper level hydrodynamics where water movements are much more frequent (i.e. due to wind action or inflows) versus lower layers that see much less movement. The numbers in each grid box indicate the lateral width of each Segment/Layer combination. The starting depth of the reservoir bathymetry is specified in the W2 control file, 'w2_con_SHA_90-24.xlsm', in line 59 (EBOT, meters above sea level), and the geographical location of the waterbody in Lat/Long is specified in L57-58. Branches go in order from left to right and the upstream and downstream Segments of each branch are also delineated in the W2 control file in lines 47-54.   
   
_Inflows:_ W2 requires inflow rates and temperature at a minimum. If you were modeling other water quality constituents, you might also have an inflow concentration file for the modeled constituent(s). The only data that the model ingests starts at row 3 and goes down, the top 2 rows are simply header information. The QIN files require units of m^3/s, TIN files are in deg C. For the model example, specifically, the TIN files for each Branch are a proportional estimate based on the aggregated Sacramento River@Shasta inflows. In other words, the Pit River, McCloud River, etc. inflows are modeled as a proportion of this aggregated flow amount based on annual average flows instead of pulled from the real-world CDEC inflow files for each Branch directly. Similarly, the TIN files are all based on the Sacramento River inflow temperatures, not separate temperature timeseries for each real-world inflow. This is a simplification that substantially reduces the dimensionality of the systems modeling, maintains mass-balance consistency with the estimated total Shasta inflows, and makes potential analyses using stochasticization much more straightforward. In addition, inflow temperatures are not available for each inflow branch.   
   
_Outflows:_ A detailed treatment of how the 4 gate Thermal Control Device (TCD) operations are implemented for this W2 model is beyond the scope of this example. However, the QOUT file is configured similarly to the QIN files, except that the outflows here are specified for each of the 5 outflow points in the Shasta Reservoir with TCD (4 selectable gates + spillway). The columns of the QOUT file correspond to the structures specified in L135-167 of the W2 control file, where the physical dimensions of the outflow structures and their elevations (absolute elev above sea level, m) are delineated. In this particular example, outflow amounts are partitioned to each of the outflow structures via a simple rule-based structure formulated outside the W2 model in a Python script to dictate release profiles that preserve the cold water pool to the max extent possible until the summer (Jun-Sep) critical spawning period for salmon.   
   
_Meteorology:_ As with other input files, the meteorology file is indexed to a Julian Day indicator (JDAY) in the first column and then the 5 required meteorological inputs in the remaining columns: air temp (TAIR, C), dewpoint temp (TDEW, C), wind speed (WIND, m/s), wind direction (PHI, radians), and cloud cover (CLOUD, 0-10 fractional cover). There are different potential sources for these data. Most gage based data would have TAIR and possibly TDEW, WIND, and PHI (likely expressed as magnetic direction). Standard reanalysis products, for example the ECMWF ERA5 data used in this study, will have all these variables available, albeit with some potential for bias. For deep-water reservoir dynamics, wind speed and certainly direction are not likely to have significant impacts. Winds will affect surface dynamics and influence mixing processes in the winter, but have much less influence on whole-reservoir temperature profiles than long term air temperature forcings, solar radiation (cloud cover impacts), and reservoir storage levels.
   
### W2 control file ('w2_con_SHA_90-24.xlsm').
_Overall:_ The majority of the features of the W2 control file are outside the scope of this example. I will discuss a few key parts of the control file that relate to basic model implementation where reservoir temperature is the focus. Most things that are not discussed can be left at 'default' settings in the current control file. The left side of the W2 control file describes what some acronyms mean in the user entry portion of the file (blue and yellow boxes). If there is a discrepancy between what is specified in the W2 control file and what is in the input files, the model will either a) not run or b) give some sort of error that may or may not be interpretable. Note also that some specifications apply to the entire Waterbody, while others must be specified for each Branch.
   
_Waterbody specification:_ L16 has inputs for the # of waterbodies (NWB), number of branches (NBR), max # of segments (IMX), and max # of layers (KMX). These need to match what's in the bathymetry files, as do the specifications in L47-62, which describe the dimensions of each of the individual Branches, how they relate to each other, and how they relate to the inflow files.   

_Time indexing:_ The important thing with running W2 is that the Julian Date convention be self-consistent. In the example, JDAY is calculated from 1/1/1950 as the reference, specified by the entry of '1950' in box A38 and E28. The calculator in A30-38 is just for reference, what the model cares about are the specifications in C28-E28. As long as these match the conventions in the input data, the model should show the correct calendar date as it runs. As of the writing of this post, I don't know how to update the JDAY reference in the W2 postprocessor, so the W2 post outputs do not match the 2/1/1990 - 8/29/2024 calendar dates of the data.   

_Simulation specifications:_ L25 includes a bunch of model calculations that can be toggled ON or OFF. These are all ancillary to the basic hydrodynamics calculations that include temperature and are thus all set to OFF for this example, since we are not interested in modeling other attributes of water quality. Their inclusion increases calculation time. Related to this, C74-75 include specification of whether to have the model calculate fluxes like evaporative water loss or precipitation on reservoir surface. Turn these OFF if these fluxes are being accounted for in other ways, ON to include them.

_Outflow structure specification:_ L135-167 are the outlet structure specification blocks. As noted in the 'Inputs/Outflows' section above, these represent the Shast TCD outlet gates from low to high (Structures 1-4) and the spillway (Structure 5). Outflows from the first QOUT column of the outflow file will be directed to Structure 1, the second QOUT column to structure 2, and so forth. L168-289 contain the litany of other potential outflow and inflow specifications (Spillways, Gates, Weirs, Tributaries, etc) that can be added to the W2 model.   

_Output specifications:_ L308-384 include a bunch of output files. In general, you can leave these alone. Of note, the W2 post output files specified in L336-341 should be ON if you want to use the W2 postprocessor tool, and the TSR PLOT (timeseries plot) in L355-363 is useful to modify. In the current example, I have specified 5 locations for TSR output, which are all on the Shasta Dam segment (TSR SEG = 21), and at differing levels in the reservoir that correspond to the outflow structures. Specifying a negative number for the TSR LAYER equates to the Layer #, while a positive # specifies a depth for TSR output. These files output to the tsr_output file and include a number of useful variables like the elevation of the water surface (ELWS), layer temperature (T2(C)), etc.   

_I/O file specifications:_ L865-901 are where the input and output files are specified. These are very important to get right obviously. Most importantly are the files I've already described in this Detailed Notes section (e.g. inflow, inflow temp, outflow, meteorology, bathymetry). The basic structure for how these files are specified is relatively intuitive. Note that some require specification per each branch, whereas some are specified for the overall waterbody.

## Contact
Zach Brodeur, zpb4@cornell.edu
